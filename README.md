# Модуль 5. Безопасность в Kafka. Практическая работа 6. 4 ДЗ

Данный проект демонстрирует работу по настройке защищённого соединения и управления доступом

___

## Структура проекта

| Компонент              | Описание                                                                         |
|------------------------|----------------------------------------------------------------------------------|
| [Сертификаты](certgen) | Генерация сертификатов для шифрования и аутентификации                           |
| [Consumer](consumer)   | Spring Boot-приложение, которое читает сообщения из Kafka и выводит их в консоль |
| [Producer](producer)   | Spring Boot-приложение, которое отправляет сообщения в Kafka                     |
| [ACL](kafka_acl)       | Настройка ACL (Access Control List) для управления доступом к ресурсам Kafka     |

---

## Запускаемые контейнеры

| Контейнер     | Назначение                                       |
|---------------|--------------------------------------------------|
| Kafka (KRaft) | 3 контроллера + 3 брокера                        |
| Kafka ACL     | Одноразовый контейнер для настройки ACL          |
| Certgen       | Одноразовый контейнер для генерации сертификатов |
| Producer      | Отправка сообщений в Kafka                       |
| Consumer      | Чтение сообщений из Kafka и вывод их в консоль   |

___

## Модель безопасности

mTLS: каждый участник имеет свой keystore (.jks) с приватным ключом и сертификатом, подписанным локальным CA. Доверие —
через общий truststore с ca.crt.

Principal = User:<CN> (из сертификата). Маппинг настроен правилом:
KAFKA_CFG_SSL_PRINCIPAL_MAPPING_RULES='RULE:^CN=([^,]+),?.*$/$1/, DEFAULT'

SUPER_USERS: брокеры и контроллеры (и acl контейнер).

ACL:

* topic-1: User:producer → WRITE, DESCRIBE; User:consumer → READ, DESCRIBE; User:consumer → READ на группы cons-*.
* topic-2: User:producer → WRITE, DESCRIBE; READ никому.

___

## Запуск

1. Запуск генерации сертификатов. Это нужно сделать один раз, чтобы получить сертификаты для брокеров и клиентов. Все
   сертификаты будут храниться в [папке](certgen/certs). Необходимо дождаться пока не появится папка `truststores`.

```bash
   docker compose --profile certs up -d
```

2. Запуск Kafka кластера и ACL контейнера. Необходимо дождаться настройки ACL. Это можно проверить по логам
   контейнера `kafka-acl-setup`. В логах должно быть сообщение `>> Done`.

```bash
   docker compose --profile kafka-cluster up -d
```

3. Запуск consumer и producer сервисов. У консбюмера не будет возможности читать сообщения из topic-2, так как
   у него нет прав на чтение этого топика. Это можно проверить по логам консюмера. В логах должно быть
   `org.apache.kafka.common.errors.TopicAuthorizationException: Not authorized to access topics: [topic-2]`

```bash
   docker compose --profile client up --build -d
```